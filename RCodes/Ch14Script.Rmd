---
title: "Chapter 14 – Logistic Regression, Poisson Regression, and Generalized Linear Models"
author: ""
date: ""
output: html_document
---

```{r setup, include=FALSE, comment=NA, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Getting data -- Programming Task Example (examples 3 and 4 in the note)

```{r comment=NA, warning=FALSE, message=FALSE}
progTaskData <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%2014%20Data%20Sets/CH14TA01.txt", sep ="" , header = FALSE)
progTaskData
progTaskData <- progTaskData[,1:2] # Remove the last column to make the data set more practical

#Look at the first 6 entries
head(progTaskData)

names(progTaskData) <- c( "X" , "Y")
head(progTaskData)
```




### Scatter plot of the data and lowess fit

Example 3 part 1 and 2

```{r}
library(ggplot2)
library(cowplot)

sp <- ggplot(progTaskData, aes(x = X, y = Y)) + geom_point(color = "steelblue") + theme_bw() 
sp
lf <- ggplot(progTaskData, aes(x = X, y = Y)) + geom_point(color = "steelblue") + theme_bw() +
  geom_smooth(method = "loess",  se = FALSE, color = "red") 

plot_grid(sp, lf)


```



### Scatter plot with Lowess and logistic mean response functions

Example 3 part 4

```{r comment=NA, warning=FALSE, message=FALSE}

ggplot(progTaskData, aes(x = X, y = Y)) + geom_point(color = "steelblue") + theme_bw() +
  geom_smooth(method = "loess",  se = FALSE, color = "red") + 
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE, color = "steelblue")

```

### Fit a  logistic regression model

Example 3 part 5 and 6

Estimated Logistic Mean Response Function–Programming Task Example

```{r comment=NA, warning=FALSE, message=FALSE}
?glm
logitfit <- glm(Y ~ X, family = binomial(link = "logit"), progTaskData)
summary(logitfit)

# Fitted values

logitfit$fitted.values # This gives fitted values from the model for each case
cbind(progTaskData, 'fitted' = logitfit$fitted.values) # Table to make it easier to read

```

### Odds ratio

Example 4 part 1

```{r comment=NA, warning=FALSE, message=FALSE}

OR <- exp(coef(logitfit)[2]) # you can also do exp(0.16149) by using summary(logitfit) output
OR
```

***

## Repeat Observations-Binomial Outcomes

```{r comment=NA, warning=FALSE, message=FALSE}
CouponData <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%2014%20Data%20Sets/CH14TA02.txt", sep ="" , header = FALSE)
head(CouponData)

CouponData <- CouponData[,1:3] # Remove the last column to make the data set more practical

#Look at the first 6 entries
head(CouponData)

names(CouponData) <- c( "X", "n" , "Y")
head(CouponData)
```


### Example 5 part 1 

```{r comment=NA, warning=FALSE, message=FALSE}
y <- c(rep(1, sum(CouponData$Y)), rep(0, 1000 - sum(CouponData$Y)))
x <- c(rep(CouponData$X, CouponData$Y), rep(CouponData$X, 200 - CouponData$Y))

newCouponData <- data.frame(y, x)
head(newCouponData)
```


### Example 5 part 2

```{r comment=NA, warning=FALSE, message=FALSE}

modelRep <- glm(y ~ x, family = binomial(link = 'logit'), data = newCouponData)
summary(modelRep)
```

### Example 5 part 4

```{r comment=NA, warning=FALSE, message=FALSE}

library(dplyr)
newCouponData_p <- newCouponData %>%
  group_by(x) %>%
  summarize(p=mean(y))

newCouponData_p
```



### Example 5 part 5

```{r comment=NA, warning=FALSE, message=FALSE}
library(ggplot2)
ggplot(data = newCouponData_p, aes(x = x, y = p)) + geom_point()+
geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE, color = "steelblue") + theme_bw()
```


### Example 5 part 6

```{r comment=NA, warning=FALSE, message=FALSE}
OR <- exp(coef(modelRep)[2]) # you can also do exp(0.096834)
OR
```


***

## Disease Outbreak Example (Portion of Model-Building Data Set).

### Example 6 part 1

```{r comment=NA, warning=FALSE, message=FALSE}
DiseaseData <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%2014%20Data%20Sets/CH14TA03.txt", sep ="" , header = FALSE)
head(DiseaseData)
dim(DiseaseData)

DiseaseData <- DiseaseData[,-1] # Remove the 'case' column

#Look at the first 6 entries
head(DiseaseData)

# Rename columns
names(DiseaseData) <- c( "x1", "x2" , "x3", "x4", "y")
head(DiseaseData)

# Fitting the logistic model
DiseaseModel <- glm(y ~ x1 + x2 + x3 + x4, data = DiseaseData, family = binomial(link = 'logit'))
summary(DiseaseModel)
```

### Example 6 part 3

```{r comment=NA, warning=FALSE, message=FALSE}
# Odds ratio
OR1 <- exp(coef(DiseaseModel)) # Or find them individually, ex odds ratio for x1 is  exp(coef(DiseaseModel)[2]) 
OR1
```


### Example 6 part 5

```{r comment=NA, warning=FALSE, message=FALSE}

# Fitted values
DiseaseModel$fitted.values # This gives fitted values from the model for each case
cbind(DiseaseData, 'fitted' = DiseaseModel$fitted.values) # Table to make it easier to read
```



















