---
title: "Diagnostics and Remedial Measures in $R$"
author: ""
date: ""
output: 
  html_document:
    number_sections: true
---

```{r setup, include=FALSE, comment=NA, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read data from an URL {-}

```{r comment=NA, warning=FALSE, message=FALSE}
toluca <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%201%20Data%20Sets/CH01TA01.txt", sep ="" , header = FALSE)


#Look at the first 6 entries
head(toluca)
```


# Rename columns {-}

```{r comment=NA, warning=FALSE, message=FALSE}
colnames(toluca) <- c("lotSize", "hours")

#Look at the first 6 entries
head(toluca)
```

# Convert your data into a `dataframe`

```{r comment=NA, warning=FALSE, message=FALSE}
tolucaDF <- data.frame(toluca)
head(tolucaDF)
```

# Diagnostic Plots for Predictor Variable-Toluca Company Example

## Dot plot 

The dot plot for the lot sizes in the Toluca Company example.

```{r comment=NA, warning=FALSE, message=FALSE}
library(ggplot2)
ggplot(data = tolucaDF, aes(x = lotSize)) + geom_dotplot(color = "blue", fill = "orchid4", dotsize = .5) + theme_bw()
```

## Sequence plot

The Sequence plot for the lot sizes in the Toluca Company example.

```{r}
plot(tolucaDF$lotSize, type = "b", lty = 2, xlab = "Run", ylab = "Lot Size")
title("Sequence Plot")
```

## Stem-and-leaf plot

Stem-and-leaf plot of the lot sizes for the Toluca Company example.  By displaying the last digits, this plot also indicates here that all lot sizes in the Toluca Company example were multiples of 10. 

```{r comment=NA, warning=FALSE, message=FALSE}
stem(tolucaDF$lotSize, scale = 3)
```
## Box plot

Box plot of the lot sizes for the Toluca Company example.  

```{r comment=NA, warning=FALSE, message=FALSE}
ggplot(data = tolucaDF, aes(x = lotSize)) + geom_boxplot(color = "steelblue", fill = "orchid4") + theme_bw()
```

# Diagnostics for Residuals (Section 3.3 in the textbook)

## Create the LS model

```{r comment=NA, warning=FALSE, message=FALSE}
# Recall from ch1
toluca_LS_model <- lm(hours ~ lotSize, data = toluca)
summary(toluca_LS_model)
```

## Plot of residuals against predictor variable

```{r comment=NA, warning=FALSE, message=FALSE}
library(ggplot2)
ggplot(toluca_LS_model, aes(x = lotSize, y = .resid)) + geom_point(color = "blue", dotsize = .5) + theme_bw() #no need to find residual seperately. Just use ".resid"
```

## Plot of residuals against fitted values.

```{r comment=NA, warning=FALSE, message=FALSE}
ggplot(toluca_LS_model, aes(x = .fitted, y = .resid)) + geom_point(color = "blue", dotsize = .5) + theme_bw() #Use the model as the data and use ".fitted" to get the fitted values for x axis
```


## Box plot of residuals

```{r}
ggplot(toluca_LS_model, aes(x = .resid)) + geom_boxplot(color = "steelblue", fill = "orchid4") + theme_bw()
```

## Normal probability plot of residuals.

```{r}
ggplot(toluca_LS_model, aes(sample = .resid)) + geom_qq(color = "blue") + geom_qq_line()+ theme_bw() #No x or y aesthetics. Just use sample =.resid
```

## Nonnormality of Error Terms

$\mbox{Exp. Value under Normality} = \sqrt(MSE)[ z(\frac{k-0.375}{n+0.25})]$

Note that MSE can be calculated below as the `SSE / DF`. Here I am using `deviance(toluca_LS_model)`

```{r comment=NA, warning=FALSE, message=FALSE}
# Expected value under normality comes from equation (3.6)
cbind(
  "Residual"                   = round(resid(toluca_LS_model), 2), # rounding upresiduals to 2 decimal places
  "Rank"                       = rank(resid(toluca_LS_model)), # this is where we find k value
  "Exp. Value under Normality" = round(sqrt(deviance(toluca_LS_model) / df.residual(toluca_LS_model)) * 
                                       qnorm((rank(resid(toluca_LS_model)) - 0.375) / (nrow(tolucaDF) + 0.25)), 2)) # deviance funtion finds the SSE and to find MSE we need to divide it by d.f. Then qnorm givres us the z value of (k-.375/n+.25). Again we have use round funtion to get final results in 2 decimal places.
```

## Correlation Test for Normality 

```{r comment=NA, warning=FALSE, message=FALSE}

res <- resid(toluca_LS_model)
expRes <- sqrt(deviance(toluca_LS_model) / df.residual(toluca_LS_model)) * 
                                       qnorm((rank(resid(toluca_LS_model)) - 0.375) / (nrow(tolucaDF) + 0.25))
cor(res, expRes)
```

## Breusch-Pagan Test for Constancy of Error Variance

```{r comment=NA, warning=FALSE, message=FALSE}
library(lmtest)
bptest(toluca_LS_model, student = FALSE)
```



## Bank example section 3.7

```{r comment=NA, warning=FALSE, message=FALSE}
bankdata <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%203%20Data%20Sets/CH03TA04.txt", sep ="" , header = FALSE)


#Look at the first 6 entries
#head(bankdata)

#Rename clumns
colnames(bankdata) <- c("minDeposit", "NoNewAccs") # minDeposit - Size of minimum deposit, NoNewAccs - Number of new accounts

#Look at the first 6 entries
(bankdata)

#Model
bankModel <- lm(NoNewAccs~minDeposit, data = bankdata)
bankModel

#ANOVA table
anova(bankModel)

#Scatter Plot
library(ggplot2)
library(latex2exp)

ggplot(bankdata, aes(x = minDeposit, y = NoNewAccs)) +
  geom_point() +
  labs(x = "Size of minimum deposit", y = "Number of new accounts", title = "Bank example scatter plot") +
  geom_smooth(method = "lm", se = FALSE) +
  geom_text(aes(x=120, label="yhat = 50.7 + 0.49x", y=85), colour="steelblue", angle=0, text=element_text(size=11)) +
  theme_bw()


library(dplyr)

dfbank <- bankdata %>%
  group_by(minDeposit) %>%
  summarize(NoNewAccs)

dfbank

dfMeanbank <- bankdata %>%
  group_by(minDeposit) %>%
  summarize(MeanAccs = mean(NoNewAccs))

dfMeanbank
```


### F test for lack of fit {-}

```{r}
# F test for lack of fit

Reduced <- lm(NoNewAccs ~ minDeposit, data = bankdata) # This is our usual model
summary(Reduced)


Full <-  lm(NoNewAccs ~ 0 + as.factor(minDeposit), data = bankdata) # This is the full model
summary(Full)
```

Testing the hypothesis:

$H_0: \mbox{Reduced model is good}$ $\quad$ $H_a: \mbox{Full model is good}$

```{r}

anova (Reduced, Full)

```


### Example on page 129 {-}

```{r comment=NA, warning=FALSE, message=FALSE, include=FALSE}
salesTrain <- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%203%20Data%20Sets/CH03TA07.txt", sep ="" , header = FALSE)

#head(salesTrain)

#Rename clumns
colnames(salesTrain) <- c("daysTrain", "performance") 
head(salesTrain)

# Create a scatter plot of these data in R
ggplot(salesTrain, aes(x = daysTrain, y = performance)) +
  geom_point() +
  labs(x = "Days", y = "Performance", title = "Sales Training Example scatter plot") +
  theme_bw()


# Do you see a linear relationship?
    # Clearly the regression relation appears to be'curvilinear, so the simple linear regression model does not seemto be appropriate.

# What transformation might be appropriate for these data?
    # We shall consider a transformation on X. We shall consider initially the square root transformation


# Find the transformed X values
    salesTrainTrans <- salesTrain %>%
      mutate(daysTrainSqrt  = sqrt(daysTrain))
    
    salesTrainTrans
  

# Create a new scatter plot of using transformed data in R
  ggplot(salesTrainTrans, aes(x = daysTrainSqrt, y = performance)) +
  geom_point(color = "blue") +
  labs(x = "Square root of Days", y = "Performance", title = "Sales Training Example scatter plot") +
  theme_bw()

    
# Fit the linear regression model using transformed data
  modelTrans <- lm(performance ~ daysTrainSqrt, data = salesTrainTrans)
  modelTrans
  
# Make a NPP and a residual plot. 
  ggplot(modelTrans, aes(sample = .resid)) + geom_qq(color = "red") + geom_qq_line()+ theme_bw() #No x or y aesthetics. Just use sample =.resid
  
  #residual plot
  ggplot(modelTrans, aes(x = daysTrainSqrt, y = .resid)) + geom_point(color = "orchid4", dotsize = .5) + theme_bw() #Use the model as the data and use ".fitted" to get the fitted values for x axis
  
  
# Perform a correlation test for normality for this data
  
  res <- resid(modelTrans)
  expRes <- sqrt(deviance(modelTrans) / df.residual(modelTrans)) * 
                                       qnorm((rank(resid(modelTrans)) - 0.375) / (nrow(salesTrainTrans) + 0.25))
  cor(res, expRes)
  
  # Notice the correlation between residuals and expected residulas is 0.9789286.
  # The critical value when alpha = 0.01, is 0.879. 
  # Since the correlation > critical value. Theredore, we conclude that the distribution of the error terms does not depart substantially from a normal distribution.
  
# Comment on lack of fit or of strong unequal error variances and normality
  
  # By looking at the residual plot there is no evidence of lack of fit or of strongly unequal error variances.
  # By looking at the NPP and above test, No strong indications of substantial departures from normality are indicated.
  
```







```{r include=FALSE}
Copier<- read.table("http://users.stat.ufl.edu/~rrandles/sta4210/Rclassnotes/data/textdatasets/KutnerData/Chapter%20%203%20Data%20Sets/CH03PR04.txt", sep ="" , header = FALSE)
#Copier

colnames(Copier) <- c("minutes", "copiers")
#Copier

CopierDF <- data.frame(Copier)
head(CopierDF)

```


```{r include=FALSE, comment=NA, warning=FALSE, message=FALSE}
#Part a)
library(ggplot2)
ggplot(data = CopierDF, aes(x = copiers)) + geom_dotplot(color = "blue", fill = "red", dotsize = .5) + theme_bw()
```

```{r include=FALSE}
#Make a quick note and answer the rest of the question

#Part b) 

#Part c)

# Recall from ch1
Copier_LS_model <- lm(minutes ~ copiers, data = Copier)
summary(Copier_LS_model)
```



```{r include=FALSE, comment=NA, warning=FALSE, message=FALSE}
stem(Copier_LS_model$resid, scale = 5)
```



```{r include=FALSE, comment=NA, warning=FALSE, message=FALSE}
#Part d) Residual plot aginst fitted values
ggplot(Copier_LS_model, aes(x =.fitted , y = .resid)) + geom_point(color = "blue", dotsize = .5) + theme_bw() #no need to find residual seperately. Just use ".resid"
ggplot(Copier_LS_model, aes(x =copiers , y = .resid)) + geom_point(color = "blue", dotsize = .5) + theme_bw() #no need to find residual seperately. Just use ".resid"
```

